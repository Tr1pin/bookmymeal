<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actualizar Producto</title>
  <style>
    .preview-container {
      margin: 10px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .image-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .current-images {
      margin: 20px 0;
    }
    .current-image {
      position: relative;
      display: inline-block;
      margin: 5px;
    }
    .current-image img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Actualizar Producto</h1>
  <form id="productoForm" method="put" enctype="multipart/form-data">
    <input type="hidden" id="productId" name="id" required>

    <label for="nombre">Nombre:</label>
    <input type="text" name="nombre" id="nombre"><br><br>

    <label for="descripcion">Descripción:</label>
    <textarea name="descripcion" id="descripcion"></textarea><br><br>

    <label for="precio">Precio:</label>
    <input type="number" name="precio" id="precio" step="0.01"><br><br>

    <label for="disponible">Disponible:</label>
    <input type="checkbox" name="disponible" id="disponible"><br><br>

    <div class="current-images">
      <h3>Imágenes actuales:</h3>
      <div id="currentImagesContainer"></div>
    </div>

    <label for="imagen">Nuevas imágenes (opcional):</label>
    <input type="file" name="imagen" id="imagen" multiple accept="image/*"><br>
    <div id="imagePreview" class="preview-container"></div>
    <br>

    <button type="submit">Actualizar Producto</button>
  </form>

  <script>
    // Cargar datos del producto
    async function loadProductData(productId) {
      try {
        const response = await fetch(`http://localhost:3001/productos/id/${productId}`);
        const product = await response.json();
        
        // Rellenar el formulario
        document.getElementById('productId').value = product.id;
        document.getElementById('nombre').value = product.nombre;
        document.getElementById('descripcion').value = product.descripcion;
        document.getElementById('precio').value = product.precio;
        document.getElementById('disponible').checked = product.disponible;

        // Mostrar imágenes actuales
        const imagesContainer = document.getElementById('currentImagesContainer');
        if (product.imagens && product.imagens !== 'null') {
          const images = JSON.parse(product.imagens);
          images.forEach(filename => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'current-image';
            
            const img = document.createElement('img');
            img.src = `http://localhost:3001/images/products/${filename}`;
            img.alt = filename;
            
            imgContainer.appendChild(img);
            imagesContainer.appendChild(imgContainer);
          });
        }
      } catch (error) {
        console.error('Error loading product:', error);
        alert('Error al cargar el producto');
      }
    }

    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    if (productId) {
      loadProductData(productId);
    } else {
      alert('ID de producto no proporcionado');
    }

    // Preview de nuevas imágenes
    document.getElementById('imagen').addEventListener('change', function(e) {
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      
      for (const file of this.files) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('image-preview');
            preview.appendChild(img);
          }
          reader.readAsDataURL(file);
        }
      }
    });

    // Manejar envío del formulario
    document.getElementById('productoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('id', document.getElementById('productId').value);
      
      // Solo agregar campos si tienen valor
      const nombre = document.getElementById('nombre').value;
      const descripcion = document.getElementById('descripcion').value;
      const precio = document.getElementById('precio').value;
      const disponible = document.getElementById('disponible').checked;
      
      if (nombre) formData.append('nombre', nombre);
      if (descripcion) formData.append('descripcion', descripcion);
      if (precio) formData.append('precio', precio);
      formData.append('disponible', disponible);

      // Agregar nuevas imágenes si se seleccionaron
      const archivos = document.getElementById('imagen').files;
      for (let i = 0; i < archivos.length; i++) {
        formData.append('imagen', archivos[i]);
      }

      try {
        const response = await fetch('http://localhost:3001/productos/', {
          method: 'PUT',
          body: formData
        });

        const data = await response.json();
        
        if (response.ok) {
          alert('Producto actualizado correctamente');
          // Recargar la página para mostrar los cambios
          window.location.reload();
        } else {
          alert('Error al actualizar el producto: ' + data.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el producto');
      }
    });
  </script>
</body>
</html> 